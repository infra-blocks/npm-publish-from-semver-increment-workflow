name: NPM Publish From Semver Increment

on:
  workflow_call:
    inputs:
      prerelease:
        type: boolean
        description: Whether the semver increment is to be interpreted as a prerelease or a full release.
        required: false
        default: false
      semver-increment:
        type: string
        description: |
          The semver label applied to the PR.
        required: true
      skip:
        type: boolean
        description: Whether to skip the workflow or not.
        required: false
        default: false
      skip-ci:
        type: boolean
        description: Whether to include `[skip ci]` in the commit created by `npm version` when `prerelease` is false.
        required: false
        default: false
    secrets:
      github-token:
        description: |
          The personal access token used to push the commit generated by `npm version` on the release branch.
        required: true
      npm-token:
        description: |
          The NPM token used to publish the packages.
        required: true

permissions:
  contents: write
  pull-requests: write

env:
  status-report-action-repository: infra-blocks/npm-publish-from-semver-increment-workflow

jobs:
  variables:
    runs-on: ubuntu-22.04
    outputs:
      sha: ${{ steps.infer-sha.outputs.sha }}
      issue-number: ${{ steps.current-pr.outputs.number }}
    steps:
      - uses: actions/checkout@v2
      - id: infer-sha
        run: |
          if [ "${{ runner.debug }}" = "1" ]; then
              set -x
          fi

          # Get the event payload. If "pull_request" is defined, take the head.sha. Othwerise, use github.sha.          
          sha=$(jq -r '.pull_request.head.sha // empty' "${GITHUB_EVENT_PATH}")
          
          if test -z "${sha}"; then
              sha="${{ github.sha }}"
          fi
          echo "sha=${sha}" >> "${GITHUB_OUTPUT}"
      - id: current-pr
        uses: infra-blocks/get-current-pull-request-action@v1

  # Release workflow.
  npm-publish-release:
    needs:
      - variables
    uses: infra-blocks/npm-publish-workflow/.github/workflows/workflow.yml@v1
    permissions:
      contents: write
    with:
      version: ${{ inputs.semver-increment }}
      dist-tags: '["latest", "git-sha-${{ needs.variables.outputs.sha }}", "gh-pr-${{ needs.variables.outputs.issue-number }}"]'
      skip: ${{ inputs.skip || inputs.prerelease }}
      skip-ci: ${{ inputs.skip-ci }}
    secrets:
      github-token: ${{ secrets.github-token }}
      npm-token: ${{ secrets.npm-token }}
  post-release-comment:
    runs-on: ubuntu-22.04
    needs:
      - variables
      - npm-publish-release
    if: ${{ !inputs.skip && !inputs.prerelease && (needs.npm-publish-release.result == 'success' || needs.npm-publish-release.result == 'failure') }}
    permissions:
      pull-requests: write
    steps:
      - if: ${{ needs.npm-publish-release.result == 'success' }}
        uses: infra-blocks/status-report-action@v1
        with:
          issue-number: ${{ needs.variables.outputs.issue-number }}
          body: |
            :rocket: **Success**: Successfully published release version!

            Packages:
            - ${{ join(fromJson(needs.npm-publish-release.outputs.links), '
            - ') }}

            Git tag: [${{ needs.npm-publish-release.outputs.git-tag }}](https://github.com/${{ github.repository }}/releases/tag/${{ needs.npm-publish-release.outputs.git-tag }})
      - if: ${{ needs.npm-publish-release.result == 'failure' }}
        uses: infra-blocks/status-report-action@v1
        with:
          issue-number: ${{ needs.variables.outputs.issue-number }}
          body: |
            :boom: **Error**: Unable to publish NPM release package with version bump {{ inputs.semver-increment }}
            See [action logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # Prerelease workflow.
  npm-publish-prerelease:
    needs:
      - variables
    uses: infra-blocks/npm-publish-prerelease-workflow/.github/workflows/workflow.yml@v1
    permissions:
      contents: read
    with:
      type: "pre${{ inputs.semver-increment }}"
      dist-tags: '["git-sha-${{ needs.variables.outputs.sha }}", "gh-pr-${{ needs.variables.outputs.issue-number }}"]'
      skip: ${{ inputs.skip || !inputs.prerelease }}
    secrets:
      npm-token: ${{ secrets.npm-token }}
  post-prerelease-comment:
    runs-on: ubuntu-22.04
    needs:
      - variables
      - npm-publish-prerelease
    if: ${{ !inputs.skip && inputs.prerelease && (needs.npm-publish-prerelease.result == 'success' || needs.npm-publish-prerelease.result == 'failure') }}
    permissions:
      pull-requests: write
    steps:
      - if: ${{ needs.npm-publish-prerelease.result == 'success' }}
        uses: infra-blocks/status-report-action@v1
        with:
          issue-number: ${{ needs.variables.outputs.issue-number }}
          body: |
            :rocket: **Success**: Successfully published prerelease version!

            Packages:
            - ${{ join(fromJson(needs.npm-publish-prerelease.outputs.links), '
            - ') }}
      - if: ${{ needs.npm-publish-prerelease.result == 'failure' }}
        uses: infra-blocks/status-report-action@v1
        with:
          issue-number: ${{ needs.variables.outputs.issue-number }}
          body: |
            :boom: **Error**: Unable to publish NPM prerelease package with version bump pre{{ inputs.semver-increment }}
            See [action logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
